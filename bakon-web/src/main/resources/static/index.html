<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
        <link rel="stylesheet" type="text/css" href="joint/joint.css" />
        <link rel="stylesheet" type="text/css" href="joint/main.css" />
        <script src="joint/jquery.min.js"></script>
        <script src="joint/lodash.min.js"></script>
        <script src="joint/backbone-min.js"></script>
        <script src="joint/joint.js"></script>
        <script src="joint/joint.shapes.devs.js"></script>
        <script src="joint/joint.shapes.features.js"></script>
        <style type="text/css">
        table.list{
            border-style: solid; 
            border-right-style: none; 
            border-bottom-style: none; 
            border-width: 1px; 
            border-color:gray;
            border-collapse:collapse;
            font-size: 12px
        }
        table.list th, table.list td {
            border-style: solid;
            border-left-style: none;
            border-top-style: none;
            border-width: 1px;
            text-align: center;
            padding: 4px;
        }
        table.list th {
            background-color: #D5D5D5
        }
        button {
            cursor:pointer;
        }
        .btn {
            cursor:pointer;   
        }
        </style>
        <title></title>
    </head>
    <body>
        <div class="wrap" style="min-height:100%">
            <div style="font-size:20px;text-align:center;margin-top:30px">
                <img src="images/pages/Logo.png" width="150px" />
                <span>智能静电防控管理系统</span>
            </div>
            <div style="background-image:url(images/pages/time.png);width:290px;height:75px;position:absolute;right:30px; top:20px">
                <div style="float:left;font-size:40px;margin-left:15px;margin-top:15px">
                    <span id="clock_hour"></span>
                    <span id="clock_minute" style="margin-left:7px"></span>
                </div>
                <div style="float:left; font-size:17px; text-align:center;margin-left:25px;margin-top:15px">
                    <span id="clock_weekday"></span>
                    <br />
                    <span id="clock_date"></span>
                </div>
                <div style="clear:both"></div>
            </div>

            <div class="main">
                <div id="paper"></div>
            </div>
        </div>
        <div id="bottom" style="margin-top:-90px;width:100%;  text-align:center;font-size:13px">
            <div style="height:30px">版权所有：深圳市白光电子科技有限公司</div>
            <table style="width:100%;height:110px; background-image:url(images/pages/bt_back.png);background-repeat: repeat-x;">
                <tr>
                    <td colspan="7">
                        <img src="images/pages/back_1.png" style="margin-top:-5px" />
                    </td>
                </tr>
                <tr>
                    <td><a href="design.html"><img src="images/pages/sj.png" width="60px" /><div>设计模式</div></a></td>
                    <td width="100px"><a href="javascript:$('#dialog_setting').show()"><img src="images/pages/sz.png" width="50px" /><div>系统设置</div></a></td>
                    <td width="100px"><a href="javascript:alert('暂不支持')"><img src="images/pages/yh.png" width="50px"/><div>用户管理</div></a></td>
                    <td width="100px"><a href="javascript:$('#dialog_records').show()"><img src="images/pages/jl.png" width="50px"/><div>记录查询</div></a></td>
                    <td width="100px"><a href="javascript:alert('暂不支持')"><img src="images/pages/sjk.png" width="50px"/><div>数据库管理</div></a></td>
                    <td width="100px"><a href="javascript:$('#dialog_help').show()"><img src="images/pages/bz.png" width="50px"/><div>帮 助</div></a></td>
                    <td><a href="#"><img src="images/pages/tc.png" width="50px" /><div>退 出</div></a></td>
                </tr>
            </table>
        </div>

        <div id="dialog_records" class="dialog">
            <div class="bar">
                <div style="float:left;margin-left:10px;">
                    <img src="images/pages/jl_s.png" width="20px" />
                </div>
                <div style="float:left;margin-left:5px;margin-top:5px">
                    <span>记录查询</span>
                </div>
                <div style="float:right;margin-right:10px;margin-top:5px;" onclick="javascript:$('#dialog_records').hide()">
                    <span class="btn">关闭</span>
                </div>
                <div style="clear:both"></div>
            </div>
            <div style="margin-top:10px;">
                <div style="float:left;margin-left:10px;">
                    <div>
                        <span>起始日期：</span>
                        <input value="2016-03-06"/>
                        <span>截止日期：</span>
                        <input value="2016-06-06"/>
                    </div>
                    <div style="border-style: solid none none none; border-width: 1px; border-color:gray;margin:5px"></div>
                    <div>
                        <span>功能类型：</span>
                        <select id="dialog_records_type" style="width:80px">
                            <option value="E">设备接地</option>
                            <option value="W">腕带接地</option>
                            <option value="T">台垫接地</option>
                        </select>
                        <span>筛选状态：</span>
                        <select style="width:60px">
                            <option>异常</option>
                            <option>正常</option>
                        </select>
                        <span>位置信息：</span>
                        <input id="dialog_records_position" style="width:30px" />
                        <span>IP：</span>
                        <input id="dialog_records_host" style="width:70px" />
                    </div>
                </div>
                <div style="float:left;margin-left:10px;margin-top:10px">
                    <button style="background-image:url(images/pages/query.png);width:47px;height:34px;border:0"></button>
                    <button style="background-image:url(images/pages/export.png);width:71px;height:34px;border:0"></button>
                </div>
                <div style="clear:both"></div>
            </div>
            <div style="margin-top:20px;margin-left:10px;height:300px;overflow:scroll">
                <table id="records" class="list" border="0" style="width:97%;  text-aligin:center">
                    <thead>
                        <tr>
                            <th>日期</th>
                            <th>时间</th>
                            <th>持续时长</th>
                            <th>功能类型</th>
                            <th>位置信息</th>
                            <th>机器IP</th>
                            <th>机器端口</th>
                            <th>工作状态</th>
                            <th>设定标准</th>
                            <th>记录值</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
            <div style="height:10px"></div>
        </div>

        <div id="dialog_setting" class="dialog" style="width:350px;" >
            <div class="bar">
                <div style="float:left;margin-left:10px;">
                    <img src="images/pages/xt.png" width="20px" />
                </div>
                <div style="float:left;margin-left:5px;margin-top:5px">
                    <span>系统设置</span>
                </div>
                <div style="float:right;margin-right:10px;margin-top:5px;" onclick="javascript:$('#dialog_setting').hide()">
                    <span class="btn">关闭</span>
                </div>
                <div style="clear:both"></div>
            </div>
            <div style="margin-top:10px;padding-left:20px;margin-bottom:20px">
                扫描频率：<input value="200"/> MS
                <div style="border-style: solid none none none; border-width: 1px; border-color:gray;margin:5px"></div>

                事件记录：
                <span><input type="checkbox"/> 离线</span>
                <span><input type="checkbox"/> 正常</span>
                <span><input type="checkbox"/> 异常</span>
                <div style="border-style: solid none none none; border-width: 1px; border-color:gray;margin:5px"></div>

                警报音：
                <span><input type="checkbox"/> 开启</span>
                <div style="border-style: solid none none none; border-width: 1px; border-color:gray;margin:5px"></div>

                <div>
                    <button>默认值</button>
                    <button>保存</button>
                </div>
            </div>
        </div>

        <div id="dialog_help" class="dialog" style="width:350px;" >
            <div class="bar">
                <div style="float:left;margin-left:10px;">
                    <img src="images/pages/help.png" width="20px" />
                </div>
                <div style="float:left;margin-left:5px;margin-top:5px">
                    <span>帮 助</span>
                </div>
                <div style="float:right;margin-right:10px;margin-top:5px;" onclick="javascript:$('#dialog_help').hide()">
                    <span class="btn">关闭</span>
                </div>
                <div style="clear:both"></div>
            </div>
            <div style="margin-top:10px;padding-left:20px;margin-bottom:20px">
                <div style="padding:20px">
                版权所有：
                </div>
                <div style="float:left;padding-top:30px;padding-right:10px">
                    <img src="images/pages/Logo.png" width="100px" />
                </div>
                <div style="float:left;line-height:20px;border-style:none none none solid;border-width:1px; padding:10px">
                    智能静电防控管理系统<br />
                    深圳市白光电子科技有限公司<br />
                    www.bakon.cn
                </div>
                <div style="clear:both"></div>
            </div>
        </div>

        <script type="text/javascript">
var graph = new joint.dia.Graph();

var paper = new joint.dia.Paper({
    el: $('#paper'),
    width: $(window).width(),
    height: $(window).height(),
    gridSize: 1,
    model: graph,
    snapLinks: true,
    linkPinning: false,
    embeddingMode: true,
    interactive: false,
    validateEmbedding: function(childView, parentView) {
        return parentView.model instanceof joint.shapes.devs.Coupled;
    },
    validateConnection: function(sourceView, sourceMagnet, targetView, targetMagnet) {
        return sourceMagnet != targetMagnet;
    }
});

function load() {
    $.getJSON( "/api/setting/1", function(data) {
        if(data != null && data.graph)
            graph.fromJSON(JSON.parse(data.graph));
    });
}

function clock() {
    var date = new Date();
    $('#clock_hour').text(("0" + date.getHours()).slice(-2));
    $('#clock_minute').text(("0" + date.getMinutes()).slice(-2));
    $('#clock_weekday').text(date.toLocaleDateString('zh-cn', { weekday: "long" }));
    $('#clock_date').text(date.toLocaleDateString('zh-cn', { year: "numeric", month: "short", day: "numeric" }));
}

function checkStatus() {
    var all = {};
    var testWarn;
    var models = graph.getElements();
    for (var i = 0; i < models.length; i++) {
        var model = models[i];
        if(model.attributes.setting) {
            all[model.id] = model.attributes.setting;

            if(!testWarn)
                testWarn = model.id;
        }
        //TODO: request status
        console.log(model);
    };

    var results = {};
    results[testWarn] = true;
    for (var id in all) {
        console.log(id);
        var model = graph.getCell(id);
        console.log(model);
        if(results[id]) {
            alarm();
            warning(model, true);
        } else
            warning(model, false);
    };
}

function alarm() {
}

function warning(m, v) {
    if(v) {
        m.warningColor = 'black';
        m.warning = setInterval(function() {
            m.attr('.label/fill', m.warningColor = (m.warningColor == 'black' ? 'red' : 'black'));
        }, 200);
    } else
        clearInterval(m.warning);

}

paper.on('cell:pointerclick', function(cellView, evt, x, y ) {
    if(cellView.model instanceof joint.shapes.feature.E
            || cellView.model instanceof joint.shapes.feature.W
            || cellView.model instanceof joint.shapes.feature.T) {
        $('#dialog_records').show();
        $('#dialog_records_type option[value="' + cellView.model.attributes.setting.type + '"]').attr('selected', true);
        $('#dialog_records_position').val(cellView.model.attributes.setting.position);
        $('#dialog_records_host').val(cellView.model.attributes.setting.host);
    }
});

$(function(){
    clock();
    setInterval(clock, 10000);

    load();
    paper.scaleContentToFit({padding:30});

    checkStatus();

    var records = [
        { 'date': '2016-03-06', 'time': '12:12:11', 'duration': '10:15', 'type': '残留电压', 'position': 'W03', 'host': '192.168.1.4', 'port': '2', 'status': '异常', 'norm': '+-80v', 'value': '+80v'}
    ];
    for (var i = 0; i < records.length; i++) {
        var r = records[i];
        $('#records tbody').append([
            '<tr>',
            '<td>' + r.date + '</td>',
            '<td>' + r.time + '</td>',
            '<td>' + r.duration + '</td>',
            '<td>' + r.type + '</td>',
            '<td>' + r.position + '</td>',
            '<td>' + r.host + '</td>',
            '<td>' + r.port + '</td>',
            '<td>' + r.status + '</td>',
            '<td>' + r.norm + '</td>',
            '<td>' + r.value + '</td>',
            '</tr>'].join(''));
    }
});
        </script>
    </body>
</html>